library(tidyverse)
library(readxl)
library(ggplot2)
library(ranger)
library(pdp)
library(ggpubr)
library(ggfortify)

if (!file.exists('figures'))
{
  dir.create('figures')
}

if (!file.exists('outputs'))
{
  dir.create('outputs')
}

data = read_excel(path = '00-Database/leafdataLarge.xlsx', na = c('','999','NA')) %>%
  select(-P_Last)

data_vein_stats = read.csv('00-Database/network_hld.csv',header=TRUE)
names(data_vein_stats)[1] = "NetID"

data_vein_stats_wide = data_vein_stats %>%
  pivot_wider(id_cols='NetID', names_from='index_radius', values_from=vein_radius_this:vein_loop_density) %>% 
  # replace NAs with 0s
  replace(is.na(.), 0)




# make pressures negative
columns_P = grepl("^P[0-9_]",names(data))
data[,columns_P] = -1 * data[,columns_P]

# # reverse order the pressure columns to be in line with standard practice
names(data)[columns_P] = rev(names(data)[columns_P])

# reverse Emb columns for the same reason
columns_Emb10 = grep("^Emb10",names(data))
columns_Emb90 = grep("^Emb90",names(data))

names(data)[columns_Emb10] = gsub("Emb10","Emb90",names(data)[columns_Emb10])
names(data)[columns_Emb90] = gsub("Emb90","Emb10",names(data)[columns_Emb90])


# calculate other columns
data = data %>% 
  mutate(Log10_Pit_size_nm = log10(Pit_size_nm)) %>%
  mutate(Slope_P90 = (1.0-0.8)/(P100-P80)) %>%
  mutate(Slope_P50 = (0.6-0.4)/(P60-P40)) %>%
  mutate(Slope_P10 = (0.2-0.0)/(P20-P0)) %>%
  mutate(Slope_P50 = ifelse(is.infinite(Slope_P50),NA,Slope_P50)) %>%
  mutate(Slope_P10 = ifelse(is.infinite(Slope_P10),NA,Slope_P10)) %>%
  # mutate(Emb_90_1_relative = Emb90_1 / (Emb90_1 + Emb90_2 + Emb90_3 + Emb90_4 + Emb90_5)) %>%
  # mutate(Emb_90_5_relative = Emb90_5 / (Emb90_1 + Emb90_2 + Emb90_3 + Emb90_4 + Emb90_5)) %>%
  # mutate(Emb_50_1_relative = Emb50_1 / (Emb50_1 + Emb50_2 + Emb50_3 + Emb50_4 + Emb50_5)) %>%
  # mutate(Emb_50_5_relative = Emb50_5 / (Emb50_1 + Emb50_2 + Emb50_3 + Emb50_4 + Emb50_5)) %>%  
  # mutate(Emb_10_1_relative = Emb10_1 / (Emb10_1 + Emb10_2 + Emb10_3 + Emb10_4 + Emb10_5)) %>%
  # mutate(Emb_10_5_relative = Emb10_5 / (Emb10_1 + Emb10_2 + Emb10_3 + Emb10_4 + Emb10_5)) %>%  
  left_join(data_vein_stats_wide, by='NetID') %>%
  mutate(sqrt_vein_density_1 = sqrt(vein_density_1)) %>%
  mutate(sqrt_vein_density_5 = sqrt(vein_density_5)) %>%
  mutate(sqrt_vein_loop_density_1 = sqrt(vein_loop_density_1)) %>%
  mutate(sqrt_vein_loop_density_5 = sqrt(vein_loop_density_5))

xvars = data %>% 
  select(Gamma:EndCapProb, Log10_Pit_size_nm, -Pit_size_nm, contains("sqrt_vein")) %>% #, RVeinave:RVesSTD) %>%
  names
  

yvars = c("kleaf","P90","P50","P10","Slope_P90","Slope_P50","Slope_P10","Emb90_1", "Emb90_5","Emb50_1", "Emb50_5","Emb10_1", "Emb10_5")#"Emb_90_1_relative","Emb_90_5_relative","Emb_50_1_relative","Emb_50_5_relative","Emb_10_1_relative","Emb_10_5_relative")


df_distances = data.frame(id=1:nrow(data), 
                    dist = apply(data %>% 
                                   select(P100:P0) %>% 
                                   scale(center=TRUE,scale=TRUE), 
                            1, function(x) {sum(x^2,na.rm=T)}))

curves = data %>% 
  mutate(id=1:nrow(.)) %>% 
  select(P100:P0, id, kleaf, Log10_Pit_size_nm) %>%
  pivot_longer(cols=P100:P0,names_to='Pressure_fraction',values_to='Pressure_value') %>%
  mutate(Pct = as.numeric(as.character(gsub("P","",Pressure_fraction)))) %>%
  left_join(df_distances,by='id')



# find outlying curves and flag / remove them

g_outliers = ggplot(curves, aes(x=dist)) +
  geom_density()
ggsave(g_outliers, file='figures/g_distance.png')



ids_outliers = curves %>% filter(dist > 50) %>% pull(id) %>% unique

data_flagged = data %>%
                      mutate(id=1:nrow(.)) %>% 
                      mutate(is_outlier = (id %in% ids_outliers))

data_no_outliers = data_flagged %>% 
  filter(is_outlier == FALSE)

write.csv(data_flagged %>% filter(is_outlier==TRUE), file='outputs/curves_flagged.csv',row.names=F)

saveRDS(data_flagged, file='outputs/data_flagged.Rdata')

# check for variables causing outliers
plots_variables_outlier = ggarrange(plotlist=lapply(xvars, function(xvar) {
  
  ggplot(data_flagged, aes_string(y=xvar,x="is_outlier")) + 
    geom_violin() +
    theme_bw() + xlab("outlier")
}))
ggsave(plots_variables_outlier, file='figures/plots_variables_outlier.pdf',width=20,height=20)





partial_plot <- function(model, x, y, z, response)
{
  pdp = partial(model, pred.var=c(x,y,z),
              grid.resolution=5)
  pdp[,3] = factor(pdp[,3])
  pdp$gf <- paste0(x,y)

  
  ggplot(pdp, aes_string(x=paste(x),y="yhat",color=paste(y), group="gf", linetype=paste(z))) + 
    geom_point() +
   # geom_line() +
    theme_bw() +
    scale_color_viridis_c(name=y) +
    ylab(response) +
    facet_wrap(~ Log10_Pit_size_nm)
}

partial_plot_1d <- function(model, x, response)
{
  cat('.')
  pdp = partial(model, pred.var=x,
              grid.resolution=10)
  
  g = ggplot(pdp, aes_string(x=paste(x),y="yhat")) + 
    geom_point() +
    geom_line() +
    theme_bw() +
    ylab(response)
  
  return(list(g=g,yvar=response,pdp=pdp))
}






analyze_rf_for_response <- function(response)
{
  cat(response)
  
  data_no_outliers_ss = data_no_outliers %>%
  	sample_n(5000) %>%
    select(all_of(c(response, xvars))) %>%
    na.omit
  
  m_this = ranger(formula(sprintf("%s ~ %s", response, paste(xvars, collapse=" + "))), 
                 data= data_no_outliers_ss,
                 max.depth = 5,
                 num.trees = 500,
                 mtry = 5,
                 seed = 1,
                 importance='impurity') 
  
  cat('*')
  
  imp_this = importance(m_this) %>% 
    as.data.frame %>% 
    rename(value='.')
  imp_this$var = row.names(imp_this)
  
  g_imp_this = ggplot(imp_this, aes(x=var,y=value)) +
    geom_bar(stat='identity',fill='purple') +
    ylab("Permutation importance") +
    xlab("Variable") +
    theme_bw() +
    ggtitle(response) +
    coord_flip()
  ggsave(g_imp_this,file=sprintf('figures/g_rf_%s_imp.png',response),width=15,height=20)
  
  pdps_this = lapply(xvars, partial_plot_1d, model=m_this, response=response)
  
  minval = min(sapply(pdps_this, function(p) { min(layer_scales(p$g)$y$range$range) }))
  maxval = max(sapply(pdps_this, function(p) { max(layer_scales(p$g)$y$range$range) }))
  
  g_all_pthis = lapply(pdps_this, function(p) { p$g + ylim(minval, maxval) })
  
  g_all_pthis = ggarrange(plotlist= g_all_pthis)
  ggsave(g_all_pthis, file=sprintf('figures/g_rf_%s_pdp_all.png',response),width=20,height=20)
  
  return(list(yvar=response, model=m_this, importance=imp_this, pdps=pdps_this))
}



# RANDOM FOREST running
# this is based on a 5000 point resample
models_rf_all = lapply(yvars, analyze_rf_for_response)






# save results
for (i in 1:length(models_rf_all))
{
  saveRDS(models_rf_all[[i]], file=sprintf('outputs/models_rf_%d_%s.Rdata',i,yvars[i]))
}
save(xvars, yvars, file='outputs/vars.Rdata')









