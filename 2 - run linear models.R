library(ggplot2)
library(dplyr)
library(data.table)
library(tidyr)
library(ggpubr)

load('outputs/models_data_rf.Rdata')


xvars_nice = xvars
names(xvars_nice) = xvars
xvars_nice["Gamma"] = "Macro - gamma"
xvars_nice["Kappa"] = "Macro - kappa"
xvars_nice["rho"] = "Macro - rho"
xvars_nice["sigma"] = "Macro - sigma"
xvars_nice["alpha"] = "Meso - alpha"
xvars_nice["Length_cm"] = "Meso - Length_cm"
xvars_nice["EndCapProb"] = "Micro - EndCapProb"
xvars_nice["perf_size_fac"] = "Micro - perf_size_fac"
xvars_nice["Log10_Pit_size_nm"] = "Micro - Log10_Pit_size_nm"
xvars_nice["nAirSeed"] = "Air - nAirSeed"
xvars_nice["AirSeedCat"] = "Air - AirSeedCat"

yvars_nice = yvars
names(yvars_nice) = yvars
yvars_nice["kleaf"] = "Kleaf"
yvars_nice["P90"] = "P90"
yvars_nice["P50"] = "P50"
yvars_nice["P10"] = "P10"
yvars_nice["Slope_P90"] = "P90 slope"
yvars_nice["Slope_P50"] = "P50 slope"
yvars_nice["Slope_P10"] = "P10 slope"
yvars_nice["Emb10_1"] = "Fraction largest veins embolized at P10"
yvars_nice["Emb10_5"] = "Fraction smallest veins embolized at P10"
yvars_nice["Emb50_1"] = "Fraction largest veins embolized at P50"
yvars_nice["Emb50_5"] = "Fraction smallest veins embolized at P50"
yvars_nice["Emb90_1"] = "Fraction largest veins embolized at P90"
yvars_nice["Emb90_5"] = "Fraction smallest veins embolized at P90"



# LINEAR MODEL with y~(.)^2
do_interaction_linear_model <- function(yvar)
{
  cat(yvar)
  
  # remove NAs in focal columns
  data_no_outliers_for_regression = data_no_outliers %>%
    select(all_of(c(xvars,yvars))) %>%
    na.omit

  data_no_outliers_for_regression_scaled = scale(data_no_outliers_for_regression) %>% 
    as.data.frame

  m_lm_scaled = lm(formula(sprintf("%s~(%s)^2",yvar,paste(xvars,collapse=" + "))),data=data_no_outliers_for_regression_scaled)
  m_lm_unscaled = lm(formula(sprintf("%s~(%s)^2",yvar,paste(xvars,collapse=" + "))),data=data_no_outliers_for_regression)
  
  
  
  # get explained variation
  r2 = summary(m_lm_scaled)$r.squared
  
  # find big coefficients
  coef(m_lm_scaled)[abs(coef(m_lm_scaled)) > 1] %>% sort
  
  coefs_scaled = as.data.frame(cbind(confint(m_lm_scaled), coef(m_lm_scaled)))
  coefs_scaled$var = row.names(coefs_scaled)
  names(coefs_scaled) = c("lower","upper","est","var")
  row.names(coefs_scaled) = NULL
  coefs_scaled = coefs_scaled %>% filter(var != "(Intercept)")
  
  coefs_scaled$significant = coefs_scaled$lower > 0 | coefs_scaled$upper < 0
  
  return(list(yvar=yvar, model_scaled=m_lm_scaled, model_unscaled=m_lm_unscaled, coefs_scaled=coefs_scaled, r2=r2))
}

models_lm_all = lapply(yvars, do_interaction_linear_model)


coefs_combined = rbindlist(lapply(models_lm_all, function(x) {
  data.frame(yvar=x$yvar, x$coefs_scaled)
  })) %>%
  filter(significant==TRUE & abs(est) > 0.1)


g_lm_estimates = ggplot(coefs_combined, aes(x=reorder(var,est),y=est,ymin=lower,ymax=upper,fill=yvar)) + 
  geom_errorbar() + 
  geom_bar(stat='identity') +
  ylim(-1.5,1.5) +
  theme_bw() +
  geom_hline(yintercept = 0,color='orange') +
  coord_flip() +
  xlab("Predictor") +
  ylab("Standardized coefficient estimate") +
  facet_wrap(~yvar)

ggsave(g_estimates, file='figures/g_lm_estimates.pdf',width=12,height=10)


r2_combined = rbindlist(lapply(models_lm_all, function(x) {data.frame(y=x$yvar,r2=x$r2)}))
g_lm_r2 = ggplot(r2_combined, aes(x=y,y=r2)) +
  geom_bar(stat='identity') +
  theme_bw() +
  ylim(0,1)
ggsave(g_lm_r2, file='figures/g_lm_r2.pdf',width=9,height=4)
