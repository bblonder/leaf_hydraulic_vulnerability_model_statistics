library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(ggfortify)
library(rhdf5)
library(data.table)

source('variable names.R')
data_all = readRDS('outputs/data_flagged.Rdata')



# load in vulnerability curves (full dataset, not the 10% points)
data_vulnerability_curves <- h5read('00-Database/dataVulMatrix.mat', "/")$dataMatrixVul


data_lps = data_all %>% 
  mutate(id=1:nrow(.)) %>% 
  select(id, Log10_Pit_size_nm) %>% 
  mutate(lps.cut = cut(Log10_Pit_size_nm,breaks=seq(0,2,by=0.5)))


set.seed(1)
# ids_balanced_random = data_lps %>% 
#   filter(!is.na(lps.cut)) %>% 
#   group_by(lps.cut) %>% 
#   sample_n(100) %>% 
#   pull(id)
ids_balanced_random = sample(data_lps$id,200)

# select 1k examples
data_vulnerability_curves_ss = data_vulnerability_curves[,c(1,3),ids_balanced_random] # select psi and K columns, also first ten samples
data_vulnerability_curves_ss[,2,] = data_vulnerability_curves_ss[,2,] * 55510.74 # convert K to mmol units

# stack up the curves
data_vulnerability_curves_ss_df = rbindlist(lapply(1:dim(data_vulnerability_curves_ss)[3], 
                                                   function(i) { 
                                                     data.frame(data_vulnerability_curves_ss[,,i],id=ids_balanced_random[i])  
                                                     }))


names(data_vulnerability_curves_ss_df) = c('Psi_MPa','Kleaf_mmol_m2_s1','id')  



data_vulnerability_curves_ss_df = data_vulnerability_curves_ss_df %>% 
  group_by(id) %>%
  mutate(pct_k = Kleaf_mmol_m2_s1/max(Kleaf_mmol_m2_s1,na.rm=TRUE), Kleafmax=max(Kleaf_mmol_m2_s1,na.rm=TRUE)) %>%
  left_join(data_lps) %>%
  filter(!is.na(lps.cut)) %>%
  filter(pct_k>0)# %>%
  #mutate(lps.cut=paste("log10 Dpore âˆˆ",lps.cut))

g_curves_random_subset = ggplot(data_vulnerability_curves_ss_df, aes(x=Psi_MPa,y=pct_k,group=factor(id),color=Kleafmax)) + 
  geom_line(alpha=0.5) +
  theme(legend.position='none') +
  theme_bw() + 
  scale_color_viridis_c(name=expression(paste('K'[leafmax], ' (mmol m'^{-2}, 's'^{-1},')'))) +
  xlab(expression(paste(-Psi," (MPa)"))) +
  ylab("Fraction of Kleafmax") +
  scale_x_sqrt() +
  theme(legend.position='bottom')# +
  #facet_wrap(~lps.cut)
ggsave(g_curves_random_subset, file='figures/g_curves_random_subset.png',width=7,height=7)









df_for_pca_vein_traits = data_all %>% 
  select(contains("sqrt_vein"), Gamma, Kappa, rho, sigma) %>%
  na.omit # only one case
names(df_for_pca_vein_traits) = gsub("Macro - ","",xvars_nice[names(df_for_pca_vein_traits)])

pca_vein_traits = prcomp(df_for_pca_vein_traits,scale=TRUE,center=TRUE)

draw_pca <- function(pc, df, x,y)
{
  autoplot(pc, data=pc, x=x,y=y, loadings = TRUE, loadings.colour = 'red',
           loadings.label.colour='black', loadings.label = TRUE, loadings.label.size = 4,
           loadings.label.repel=TRUE,
           color=gray(0,0.005)) +
    theme_bw()
}

g_pca_vein = ggarrange(
  draw_pca(pca_vein_traits,df_for_pca_vein_traits,1,2),
  draw_pca(pca_vein_traits,df_for_pca_vein_traits,1,3),
  draw_pca(pca_vein_traits,df_for_pca_vein_traits,2,3),
  nrow=2,ncol=2,
  labels='auto'
)
ggsave(g_pca_vein, file='figures/g_pca_vein.png',width=8,height=8)



df_for_pca_yvars = data_all %>% 
  select(all_of(yvars)) %>%
  na.omit
names(df_for_pca_yvars) = yvars_nice[names(df_for_pca_yvars)]


pca_yvars = prcomp(df_for_pca_yvars,scale=TRUE,center=TRUE)

g_pca_yvars = ggarrange(
  draw_pca(pca_yvars,df_for_pca_yvars,1,2),
  draw_pca(pca_yvars,df_for_pca_yvars,1,3),
  draw_pca(pca_yvars,df_for_pca_yvars,2,3),
  nrow=2,ncol=2,
  labels='auto'
)
ggsave(g_pca_yvars, file='figures/g_pca_yvars.png',width=8,height=8)






# plot networks
data_vein_stats = read.csv('00-Database/network_hld.csv',header=TRUE) %>%
  # convert into mm units
  mutate(vein_density = vein_density / 1000) %>% # convert m to mm
  mutate(vein_loop_density = vein_loop_density / 1000^2) %>% # convert m to mm
  mutate(vein_radius_this = vein_radius_this * 1000) # convert m to mm
names(data_vein_stats)[1] = "NetID"

# plot networks
size_classes = data_vein_stats %>% 
  select(index_radius, vein_radius_this) %>% 
  unique

g_vd = ggplot(data_vein_stats, aes(x=vein_radius_this, y=vein_density,group=NetID)) + 
  geom_line(alpha=0.007,color='blue4') + 
  theme_bw() +
  theme(legend.position='none') +
  xlab("Vein radius (mm)") + 
  ylab(expression(paste("Vein density (VD, mm"^{-1},")"))) +
  scale_x_sqrt() +
  geom_vline(data=size_classes,aes(xintercept=vein_radius_this),color='red') +
  geom_label(data=size_classes,aes(x=vein_radius_this,y=0,label=index_radius),inherit.aes=FALSE)


g_loopiness = ggplot(data_vein_stats, aes(x=vein_radius_this, y=vein_loop_density,group=NetID)) + 
  geom_line(alpha=0.007,color='blue4') + 
  theme_bw() +
  theme(legend.position='none') +
  xlab("Vein radius (mm)") + 
  ylab(expression(paste("Vein loop density (LD, mm"^{-2},")"))) +
  scale_x_sqrt() +
  geom_vline(data=size_classes,aes(xintercept=vein_radius_this),color='red') +
  geom_label(data=size_classes,aes(x=vein_radius_this,y=0,label=index_radius),inherit.aes=FALSE)



ggsave(ggarrange(g_vd, g_loopiness,align='hv',labels='auto'), file='figures/g_vein_traits.png',width=8,height=5)


