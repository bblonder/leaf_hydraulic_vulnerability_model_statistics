library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpubr)
library(ggfortify)


load('outputs/models_data_rf.Rdata')


xvars_nice = xvars
names(xvars_nice) = xvars
xvars_nice["Gamma"] = "Macro - γ"
xvars_nice["Kappa"] = "Macro - κ"
xvars_nice["rho"] = "Macro - ρ"
xvars_nice["sigma"] = "Macro - σ"
xvars_nice["alpha"] = "Meso - α"
xvars_nice["Length_cm"] = "Meso - Lconduit"
xvars_nice["EndCapProb"] = "Micro - Pcap"
xvars_nice["perf_size_fac"] = "Micro - Perf factor"
xvars_nice["Log10_Pit_size_nm"] = "Micro - log10 Dpore"
xvars_nice["nAirSeed"] = "Air - Nairseed"
xvars_nice["AirSeedCat"] = "Air - Vcat"
xvars_nice = gsub("vein_density","Macro - √VD", xvars_nice)
xvars_nice = gsub("vein_loop_density","Macro - √LD", xvars_nice)
xvars_nice = gsub("sqrt","", xvars_nice)
xvars_nice = gsub("_","", xvars_nice)


yvars_nice = yvars
names(yvars_nice) = yvars
yvars_nice["kleaf"] = "Kleaf"
yvars_nice["P90"] = "Ψ90"
yvars_nice["P50"] = "Ψ50"
yvars_nice["P10"] = "Ψ10"
yvars_nice["Slope_P90"] = "ΨSlope90"
yvars_nice["Slope_P50"] = "ΨSlope50"
yvars_nice["Slope_P10"] = "ΨSlope10"
yvars_nice=gsub("_",",",yvars_nice)

data_all = readRDS('outputs/data_all.Rdata')


df_distances = data.frame(id=1:nrow(data_all), 
                          dist = apply(data_all %>% 
                                         select(P100:P0) %>% 
                                         scale(center=TRUE,scale=TRUE), 
                                       1, function(x) {sum(x^2,na.rm=T)}))

curves = data_all %>% 
  mutate(id=1:nrow(.)) %>% 
  select(P100:P0, id, kleaf, Log10_Pit_size_nm, Gamma) %>%
  pivot_longer(cols=P100:P0,names_to='Pressure_fraction',values_to='Pressure_value') %>%
  mutate(Pct = as.numeric(as.character(gsub("P","",Pressure_fraction)))) %>%
  left_join(df_distances,by='id')





# plot non-outlier vulnerability curves
g_curves_no_outlier = ggplot(curves %>% 
                               filter(dist<=50) %>%
                               mutate(k=kleaf*Pct) %>%
                               mutate(lps.cut = cut(Log10_Pit_size_nm,breaks=seq(0,2,by=0.5))) %>%
                               na.omit
                             ,aes(x=Pressure_value,y=Pct,group=id,color=Log10_Pit_size_nm)) +
  geom_line(alpha=0.08) +
  theme_bw() +
  scale_color_viridis_c(name='Log10 Dpore') +
  xlab(expression(paste(Psi," (MPa)"))) +
  ylab("Percent of maximum Kleaf") +
  scale_x_reverse() +
  facet_wrap(~lps.cut)





ggsave(g_curves_no_outlier,file='figures/g_curves_no_outlier.png',width=8,height=5)




df_for_pca_vein_traits = data_all %>% 
  select(contains("sqrt_vein"), Gamma, Kappa, rho, sigma) %>%
  na.omit # only one case
names(df_for_pca_vein_traits) = gsub("Macro - ","",xvars_nice[names(df_for_pca_vein_traits)])

pca_vein_traits = prcomp(df_for_pca_vein_traits,scale=TRUE,center=TRUE)

draw_pca <- function(pc, df, x,y)
{
  autoplot(pc, data=pc, x=x,y=y, loadings = TRUE, loadings.colour = 'red',
           loadings.label.colour='red', loadings.label = TRUE, loadings.label.size = 4,
           loadings.label.repel=TRUE,
           color=gray(0,0.005)) +
    theme_bw()
}

g_pca_vein = ggarrange(
  draw_pca(pca_vein_traits,df_for_pca_vein_traits,1,2),
  draw_pca(pca_vein_traits,df_for_pca_vein_traits,1,3),
  draw_pca(pca_vein_traits,df_for_pca_vein_traits,2,3),
  nrow=1,
  labels='auto'
)
ggsave(g_pca_vein, file='figures/g_pca_vein.png',width=12,height=5)



df_for_pca_yvars = data_all %>% 
  select(all_of(yvars)) %>%
  na.omit
names(df_for_pca_yvars) = yvars_nice[names(df_for_pca_yvars)]


pca_yvars = prcomp(df_for_pca_yvars,scale=TRUE,center=TRUE)

g_pca_yvars = ggarrange(
  draw_pca(pca_yvars,df_for_pca_yvars,1,2),
  draw_pca(pca_yvars,df_for_pca_yvars,1,3),
  draw_pca(pca_yvars,df_for_pca_yvars,2,3),
  nrow=1,
  labels='auto'
)
ggsave(g_pca_yvars, file='figures/g_pca_yvars.png',width=12,height=5)






# plot networks
data_vein_stats = read.csv('00-Database/network_hld.csv',header=TRUE) %>%
  # convert into mm units
  mutate(vein_density = vein_density / 100) %>% # because 10 mm per length, 1000 mm/m
  mutate(vein_loop_density = vein_loop_density / (100^2)) %>% # because 10 mm per length, 1000 mm/m
  mutate(vein_radius_this = vein_radius_this * 10^3) %>% # because 1 mm per radius
  select(-vein_mean_perimeter_per_loop_area)
names(data_vein_stats)[1] = "NetID"

# plot networks
size_classes = data_vein_stats %>% 
  select(index_radius, vein_radius_this) %>% 
  unique

g_vd = ggplot(data_vein_stats, aes(x=vein_radius_this, y=vein_density,group=NetID)) + 
  geom_line(alpha=0.007,color='blue4') + 
  theme_bw() +
  theme(legend.position='none') +
  xlab("Vein radius (mm)") + 
  ylab("Vein density (VD, mm-1)") +
  scale_x_sqrt() +
  geom_vline(data=size_classes,aes(xintercept=vein_radius_this),color='red') +
  geom_label(data=size_classes,aes(x=vein_radius_this,y=0,label=index_radius),inherit.aes=FALSE)


g_loopiness = ggplot(data_vein_stats, aes(x=vein_radius_this, y=vein_loop_density,group=NetID)) + 
  geom_line(alpha=0.007,color='blue4') + 
  theme_bw() +
  theme(legend.position='none') +
  xlab("Vein radius (mm)") + 
  ylab("Vein loop density (LD, mm-2)") +
  scale_x_sqrt() +
  geom_vline(data=size_classes,aes(xintercept=vein_radius_this),color='red') +
  geom_label(data=size_classes,aes(x=vein_radius_this,y=0,label=index_radius),inherit.aes=FALSE)



ggsave(ggarrange(g_vd, g_loopiness,align='hv',labels='auto'), file='figures/g_vein_traits.png',width=8,height=5)


