library(ggplot2)
library(dplyr)
library(data.table)
library(tidyr)
library(ggpubr)

load('outputs/models_data_rf.Rdata')


xvars_nice = xvars
names(xvars_nice) = xvars
xvars_nice["Gamma"] = "Macro - γ"
xvars_nice["Kappa"] = "Macro - κ"
xvars_nice["rho"] = "Macro - ρ"
xvars_nice["sigma"] = "Macro - σ"
xvars_nice["alpha"] = "Meso - α"
xvars_nice["Length_cm"] = "Meso - Lconduit"
xvars_nice["EndCapProb"] = "Micro - Pcap"
xvars_nice["perf_size_fac"] = "Micro - Perf factor"
xvars_nice["Log10_Pit_size_nm"] = "Micro - log10 Dpore"
xvars_nice["nAirSeed"] = "Air - Nairseed"
xvars_nice["AirSeedCat"] = "Air - Vcat"
xvars_nice = gsub("vein_density","Macro - √VD", xvars_nice)
xvars_nice = gsub("vein_loop_density","Macro - √LD", xvars_nice)
xvars_nice = gsub("sqrt","", xvars_nice)
xvars_nice = gsub("_","", xvars_nice)


yvars_nice = yvars
names(yvars_nice) = yvars
yvars_nice["kleaf"] = "Kleaf"
yvars_nice["P90"] = "Ψ90"
yvars_nice["P50"] = "Ψ50"
yvars_nice["P10"] = "Ψ10"
yvars_nice["Slope_P90"] = "ΨSlope90"
yvars_nice["Slope_P50"] = "ΨSlope50"
yvars_nice["Slope_P10"] = "ΨSlope10"
yvars_nice=gsub("_",",",yvars_nice)

# combine all the PDPs
pdps_all = rbindlist(lapply(models_rf_all, function(model_this) {
  rbindlist(lapply(model_this$pdps, function(x) {
    df = x$pdp %>% 
      mutate(yvar=x$yvar)
    xvar = names(df)[1]
    names(df)[1] = "x"
    df = df %>% 
      mutate(xvar=xvar)
    return(df)
  }))
}))

# scale the y variables
df_ranges = data_no_outliers[,yvars] %>% 
  pivot_longer(cols=everything()) %>%
  rename(yvar=name) %>%
  group_by(yvar) %>%
  summarize(mean=mean(value,na.rm=T),sd=sd(value,na.rm=T))

pdps_all_scaled = pdps_all %>%
  left_join(df_ranges,by='yvar') %>%
  mutate(yhat_scaled = (yhat-mean)/sd) %>%
  # add nice names
  mutate(xvar_nice=xvars_nice[xvar]) %>%
  mutate(yvar_nice=yvars_nice[yvar])


# embolisms
draw_pdps <- function(pattern, xvars_exclude="")
{
  ggplot(pdps_all_scaled %>% 
           filter(grepl(pattern,yvar)) %>%
           filter(!xvar %in% xvars_exclude), aes(x=x,y=yhat_scaled,color=yvar_nice,shape=yvar_nice)) +
    facet_wrap(~xvar_nice,scales='free_x',nrow=1,labeller = labeller(xvar_nice = label_wrap_gen(12))) +
    geom_hline(yintercept = 0) +
    #geom_point(size=2) +
    geom_line(linewidth=1) +
    theme_bw() +
    xlab("Predictor value") +
    ylab("Scaled prediction") +
    scale_color_discrete(name='Variable') +
    scale_shape(name='Variable') + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}

g_emb = draw_pdps("^Emb")
g_p = draw_pdps("^P")
g_slope = draw_pdps("^Slope")
g_k = draw_pdps("^k")

ggarrange(g_k, g_p, g_slope, g_emb, ncol=1,align='hv',labels='auto') %>% 
  ggsave(width=13,height=10,file='figures/g_pdps_by_category.png', limitsize=FALSE)


xvars_exclude = c("Kappa","rho","nAirSeed","AirSeedCat","perf_size_fac","sqrt_vein_density_2","sqrt_vein_density_5","sqrt_vein_loop_density_2","sqrt_vein_loop_density_5")
g_emb_exclude = draw_pdps("^Emb",xvars_exclude)
g_p_exclude = draw_pdps("^P",xvars_exclude)
g_slope_exclude = draw_pdps("^Slope",xvars_exclude)
g_k_exclude = draw_pdps("^k",xvars_exclude)
ggarrange(g_k_exclude, g_p_exclude, g_slope_exclude, g_emb_exclude, ncol=1,align='hv',labels='auto') %>% 
  ggsave(width=7,height=9,file='figures/g_pdps_by_category_exclude.png', limitsize=FALSE)



# also look at importances
importances = rbindlist(lapply(models_rf_all, function(x) {
  result = data.frame(yvar=x$yvar,x$importance %>% rename(importance=value,xvar=var))
  row.names(result) = NULL
  return(result)
  })) %>%
  mutate(xvar_nice=xvars_nice[xvar], yvar_nice=yvars_nice[yvar])


draw_importances <- function(pattern)
{
  g_importance = ggplot(importances %>% filter(grepl(pattern,yvar)), 
                        aes(x=xvar_nice,y=importance)) + 
    geom_bar(stat='identity',position='dodge',fill='purple') +
    facet_wrap(~yvar_nice,scales='free_x',nrow=1,labeller = labeller(yvar_nice = label_wrap_gen(30))) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = 'none') +
    xlab('Predictor') +
    ylab('Importance')
}

g_imp_emb = draw_importances("^Emb")
g_imp_p = draw_importances("^P")
g_imp_slope = draw_importances("^Slope")
g_imp_k = draw_importances("^k")

ggarrange(g_imp_k, g_imp_p, g_imp_slope, g_imp_emb, align='h',ncol=1,labels='auto') %>% 
  ggsave(width=6,height=9,file='figures/g_importance_by_category.png', limitsize=FALSE)

