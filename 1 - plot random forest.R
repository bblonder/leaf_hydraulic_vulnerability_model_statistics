library(ggplot2)
library(dplyr)
library(data.table)
library(tidyr)
library(ggpubr)

source('variable names.R')

files_models = dir('outputs',pattern='^models_rf*', full.names = TRUE)

models_rf_all = lapply(files_models, readRDS)

data_no_outliers = readRDS('outputs/data_flagged.Rdata') %>% 
  filter(is_outlier == FALSE)





# combine all the PDPs
pdps_all = rbindlist(lapply(models_rf_all, function(model_this) {
  rbindlist(lapply(model_this$pdps, function(x) {
    df = x$pdp %>% 
      mutate(yvar=x$yvar)
    xvar = names(df)[1]
    names(df)[1] = "x"
    df = df %>% 
      mutate(xvar=xvar)
    return(df)
  }))
}))

# scale the y variables
df_ranges = data_no_outliers[,yvars] %>% 
  pivot_longer(cols=everything()) %>%
  rename(yvar=name) %>%
  group_by(yvar) %>%
  summarize(mean=mean(value,na.rm=T),sd=sd(value,na.rm=T))

pdps_all_scaled = pdps_all %>%
  left_join(df_ranges,by='yvar') %>%
  mutate(yhat_scaled = (yhat-mean)/sd) %>%
  # add nice names
  mutate(xvar_nice=xvars_nice[xvar]) %>%
  mutate(yvar_nice=yvars_nice[yvar])


# embolisms
draw_pdps <- function(pattern, xvars_exclude="")
{
  ggplot(pdps_all_scaled %>% 
           filter(grepl(pattern,yvar)) %>%
           filter(!xvar %in% xvars_exclude), aes(x=x,y=yhat_scaled,color=yvar_nice,shape=yvar_nice)) +
    facet_wrap(~xvar_nice,scales='free_x',nrow=1,labeller = labeller(xvar_nice = label_wrap_gen(12))) +
    geom_hline(yintercept = 0) +
    #geom_point(size=2) +
    geom_line(linewidth=1) +
    theme_bw() +
    xlab("Predictor value") +
    ylab("Scaled prediction") +
    scale_color_discrete(name='Variable') +
    scale_shape(name='Variable') + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}

g_emb = draw_pdps("^Emb")
g_p = draw_pdps("^P")
g_slope = draw_pdps("^Slope")

g_k = draw_pdps("^k")

ggarrange(g_p, g_slope, g_emb, ncol=1,align='hv',labels='auto') %>% 
  ggsave(width=13,height=9,file='figures/g_pdps_by_category.png', limitsize=FALSE)


ggsave(g_k, width=13,height=4,file='figures/g_pdps_by_category_k.png')

xvars_exclude = c("Kappa","rho","nAirSeed","AirSeedCat","perf_size_fac","sqrt_vein_density_2","sqrt_vein_density_5","sqrt_vein_loop_density_2","sqrt_vein_loop_density_5")
g_emb_exclude = draw_pdps("^Emb",xvars_exclude)
g_p_exclude = draw_pdps("^P",xvars_exclude)
g_slope_exclude = draw_pdps("^Slope",xvars_exclude)

ggarrange(g_p_exclude, g_slope_exclude, g_emb_exclude, ncol=1,align='hv',labels='auto') %>% 
  ggsave(width=8,height=6,file='figures/g_pdps_by_category_exclude.png', limitsize=FALSE)


g_k_exclude = draw_pdps("^k",xvars_exclude)
ggsave(g_k_exclude, width=8,height=4,file='figures/g_pdps_by_category_exclude_k.png')



# also look at importances
importances = rbindlist(lapply(models_rf_all, function(x) {
  result = data.frame(yvar=x$yvar,x$importance %>% rename(importance=value,xvar=var))
  row.names(result) = NULL
  return(result)
  })) %>%
  mutate(xvar_nice=xvars_nice[xvar], yvar_nice=yvars_nice[yvar])


draw_importances <- function(pattern)
{
  imp_this = importances %>% 
    filter(grepl(pattern,yvar)) %>%
    mutate(category=sapply(strsplit(xvar_nice, " - "),head,1))
  print(imp_this)
  
  g_importance = ggplot(imp_this, 
                        aes(x=xvar_nice,y=importance,fill=category)) + 
    geom_bar(stat='identity',position='dodge') +
    facet_wrap(~yvar_nice,scales='free_x',nrow=1,labeller = labeller(yvar_nice = label_wrap_gen(30))) +
    coord_flip() +
    theme_bw() +
    theme(legend.position = 'none') +
    xlab('Predictor') +
    ylab('Importance') +
    theme(legend.position = "none") +
    scale_fill_brewer(palette='Set2')
}

g_imp_emb = draw_importances("^Emb")
g_imp_p = draw_importances("^P")
g_imp_slope = draw_importances("^Slope")


ggarrange(g_imp_p, g_imp_slope, g_imp_emb, align='h',ncol=1,labels='auto') %>% 
  ggsave(width=7,height=7,file='figures/g_importance_by_category.png', limitsize=FALSE)


g_imp_k = draw_importances("^k")
ggsave(g_imp_k, width=7,height=4,file='figures/g_importance_by_category_k.png', limitsize=FALSE)

